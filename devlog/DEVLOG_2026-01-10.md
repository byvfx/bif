# Development Log - 2026-01-10

## Session Goal
Performance optimizations from vfx-code-reviewer feedback on Milestone 14 (GPU Instancing + LOD)

## Completed

### 1. Pre-allocate culling scratch buffers
- Added `CullingScratch` struct with pre-allocated Vecs
- Reuse buffers via `clear()` instead of allocating new Vecs each frame
- Eliminates ~80MB/sec allocation pressure at 60fps/10K instances
- Commit: `perf: pre-allocate culling scratch buffers`

### 2. Partial sort optimization
- Replaced full `sort_by` with `select_nth_unstable`
- O(n) partitioning vs O(n log n) full sort
- Only need nearest N instances to fill polygon budget
- Commit: `perf: use select_nth_unstable for O(n) LOD partitioning`

### 3. AABB transform allocation fix
- Removed Vec allocation in `transform_aabb`
- Track min/max inline while transforming corners
- Zero heap allocations for AABB transform
- Commit: `perf: eliminate heap alloc in transform_aabb`

### 4. Frustum caching
- Cache frustum when camera static
- Skip matrix multiplication + plane extraction if camera unchanged
- Uses CameraSnapshot dirty detection
- Commit: `perf: cache frustum when camera static`

### 5. Instance count warning
- Log warning if instance count > MAX_INSTANCES (10K)
- Prevents silent truncation
- Commit: `perf: warn when instance count exceeds buffer capacity`

## Remaining (Deferred)
- [ ] Merge instance buffers (near/far into single buffer with offsets)
  - Lower priority, modest benefit at current scale

## Commits This Session
```
c6556c0 perf: warn when instance count exceeds buffer capacity
f7b8b8e perf: cache frustum when camera static
8d7b8ff perf: eliminate heap alloc in transform_aabb
cb49aa2 perf: use select_nth_unstable for O(n) LOD partitioning
3ec352f perf: pre-allocate culling scratch buffers
```

## Learnings
- `Vec::clear()` is O(1) - keeps capacity, just resets length
- `select_nth_unstable` partitions without full sort - O(n) vs O(n log n)
- Frustum calculation involves matrix multiply + 6 plane extractions - worth caching
- CameraSnapshot pattern useful for dirty detection

## Next Session
- Milestone 15 (Materials/MaterialX) or continue optimizations
- Consider GPU compute culling for 100K+ scale
