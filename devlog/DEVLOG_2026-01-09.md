# Development Log - 2026-01-09

## Session Duration

~3 hours

## Goals

Fix USD mesh rendering issues - meshes appearing inside-out/incorrectly in viewport

## What I Did

### Issue Investigation

- Water surface USD (empty normals) rendered with inverted/incorrect geometry
- Walker scan USD (has normals) rendered correctly
- Initial hypothesis: normal direction issue from cross product order

### Root Cause Discovery

- Created `debug_usd_mesh` tool to inspect USD geometry
- Analyzed vertex indices: `[1, 0, 4]` pattern showed **clockwise winding**
- USD standard uses CW winding, not CCW as originally assumed
- Original code comment "flipped for USD/Houdini winding" was backwards

### Solution

Changed BIF to use clockwise winding convention:

1. **wgpu pipeline** (`lib.rs:936`):
   - Changed `front_face: FrontFace::Ccw` → `FrontFace::Cw`
   - Matches USD's CW vertex order

2. **Normal computation** (`mesh.rs:90`, `triangle.rs:33`):
   - Changed `edge1.cross(edge2)` → `edge2.cross(edge1)`
   - Produces outward-pointing normals for CW winding

3. **Test updates** (`mesh.rs:230`):
   - Updated `test_compute_normals` expectations for CW convention

### Files Modified

- `crates/bif_core/src/mesh.rs` - normal computation
- `crates/bif_renderer/src/triangle.rs` - raytracer normal computation
- `crates/bif_renderer/examples/simple_render.rs` - clippy lint fix
- `crates/bif_viewport/src/lib.rs` - wgpu winding order
- `crates/bif_viewer/Cargo.toml` - added `default-run`
- `crates/bif_viewer/src/bin/debug_usd_mesh.rs` - NEW debug tool
- `test.ps1` - NEW test script with USD DLLs

### Validation

- ✅ Both USD files render correctly (water + walker)
- ✅ All tests pass with `test.ps1` (17 core, 34 math tests)
- ✅ Clippy clean
- ✅ Code formatted
- ✅ Committed: `e9abf84`

## Learnings

### USD Winding Convention

- USD exports **clockwise** vertex winding (when viewed from outside)
- This differs from many graphics APIs that default to CCW
- Houdini/Solaris follows USD standard (CW winding)
- Must match winding in both rasterizer (wgpu) and normal computation

### Cross Product Directionality

- `edge1 × edge2` produces CCW normal (left-hand coordinate perspective)
- `edge2 × edge1` produces CW normal (right-hand coordinate perspective)
- Normal direction must match face winding for correct culling

### Testing with Native Dependencies

- USD C++ library requires DLLs at runtime
- Created `test.ps1` to load USD environment before running tests
- Cargo test alone fails with `STATUS_DLL_NOT_FOUND` on Windows

### Debugging Degenerate Triangles

- High-res water mesh had many degenerate triangles (zero area)
- Cross product of collinear edges = zero vector
- Debug tool needed to skip degenerate tris when analyzing winding

## Next Session

- Continue with milestone 13 (USD integration)
- Materials system (milestone 14)
- Consider: add winding order detection per-USD file (orientation attribute)
