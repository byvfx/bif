# Development Log - 2026-01-11

## Session Goal
Milestone 15: Materials (UsdPreviewSurface + Textures)

## Completed

### Phase 1: UV Coordinate Support
- Added `uvs: Option<Vec<[f32; 2]>>` to Mesh struct
- Extract primvars:st from USD via C++ bridge
- Added UV to Vertex struct in viewport
- Updated basic.wgsl to pass UV to fragment shader
- Shifted instance data locations 4-7 to make room for UV at location 3
- Commit: `feat: add UV coordinate support throughout mesh pipeline`

### Phase 2: Material Data Structures
- Expanded Material struct with full PBR properties:
  - diffuse_color, metallic, roughness, specular, opacity, emissive_color
  - Texture paths: diffuse, roughness, metallic, normal, emissive
- Added `has_textures()`, `is_emissive()` helpers
- Added materials storage to Scene with add/get methods
- Commit: `feat: expand Material struct with full PBR properties`

### Phase 3: C++ Bridge Material Extraction
- Added UsdBridgeMaterialData struct with PBR properties + texture paths
- Added usd_bridge_get_material_count/get_material functions
- Added usd_bridge_get_mesh_material_path for material bindings
- Parse UsdPreviewSurface shader network + texture connections
- Link usd_usdShade library
- Commit: `feat: add UsdPreviewSurface material extraction to C++ bridge`

### Phase 4: Rust Material Loading
- Added UsdMaterialData struct and FFI bindings
- Added material_count(), get_material(), get_mesh_material_path() to UsdStage
- Updated loader to load materials and bind to prototypes
- Commit: `feat: add Rust material loading from USD`

### Phase 5: Texture Loading System
- Created TextureCache with image crate
- sRGB to linear conversion for color textures
- Bilinear filtering in Texture::sample()
- Base directory resolution for relative paths
- Commit: `feat: add texture loading system for materials`

### Phase 6: Disney Principled BSDF
- Full Disney BSDF implementation in bif_renderer
- Burley diffuse lobe with subsurface approximation
- GGX specular with importance sampling
- Metallic/dielectric Fresnel blending
- Sheen for cloth-like materials
- Commit: `feat: implement Disney Principled BSDF`

### Phase 7: Ivar Material Integration
- Added From<&bif_core::Material> impl for DisneyBSDF
- Store scene_material in viewport
- Convert loaded USD materials to Disney BSDF for rendering
- EmbreeScene now uses materials from loaded scenes
- Commit: `feat: integrate Disney BSDF materials into Ivar renderer`

### Phase 9: Testing and Documentation
- All 93+ tests passing
- Updated MILESTONES.md with M15 completion
- Updated SESSION_HANDOFF.md
- Created devlog

## Commits This Session
```
e57fe6f feat: add UV coordinate support throughout mesh pipeline
43d2a5a feat: expand Material struct with full PBR properties
08ffc9b feat: add UsdPreviewSurface material extraction to C++ bridge
d2790a5 feat: add Rust material loading from USD
94e11ba feat: add texture loading system for materials
7b0e32c feat: implement Disney Principled BSDF
df670a8 feat: integrate Disney BSDF materials into Ivar renderer
```

## Deferred

### Phase 8: Viewport Texture Support
- GPU texture upload and sampling (deferred to M16)
- Basic PBR in Vulkan viewport (deferred to M16)

## Key Files Created/Modified

| File | Changes |
|------|---------|
| `crates/bif_core/src/texture.rs` | NEW - Texture loading system |
| `crates/bif_renderer/src/disney.rs` | NEW - Disney BSDF implementation |
| `crates/bif_core/src/mesh.rs` | Added uvs field |
| `crates/bif_core/src/scene.rs` | Expanded Material struct |
| `cpp/usd_bridge/usd_bridge.h` | Material data struct + APIs |
| `cpp/usd_bridge/usd_bridge.cpp` | UsdShade extraction |
| `crates/bif_core/src/usd/cpp_bridge.rs` | Material FFI bindings |
| `crates/bif_core/src/usd/loader.rs` | Material loading |
| `crates/bif_viewport/src/lib.rs` | UV in Vertex, Disney BSDF integration |
| `crates/bif_viewport/src/shaders/basic.wgsl` | UV attribute |
| `crates/bif_core/build.rs` | Link usd_usdShade |

## Learnings
- UsdShade material network: Material -> Surface output -> Shader prim -> Inputs
- UsdPreviewSurface inputs: diffuseColor, metallic, roughness, opacity, etc.
- Texture connections: Input -> UsdUVTexture shader -> file input with SdfAssetPath
- wgpu vertex attribute locations need to be sequential; shifted instance data to 4-7
- Disney BSDF is importance sampled by GGX distribution for efficient specular
- Burley diffuse is energy-conserving unlike Lambertian

## Next Session
- M16: Viewport PBR + Textures
  - GPU texture upload
  - Texture bind group in render pipeline
  - Update basic.wgsl for sampling
  - Material ID per instance
