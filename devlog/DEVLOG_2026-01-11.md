# Development Log - 2026-01-11

## Session Goal
Milestone 15: Materials (UsdPreviewSurface + Textures)

## Completed

### Phase 1: UV Coordinate Support
- Added `uvs: Option<Vec<[f32; 2]>>` to Mesh struct
- Extract primvars:st from USD via C++ bridge
- Added UV to Vertex struct in viewport
- Updated basic.wgsl to pass UV to fragment shader
- Shifted instance data locations 4-7 to make room for UV at location 3
- Commit: `feat: add UV coordinate support throughout mesh pipeline`

### Phase 2: Material Data Structures
- Expanded Material struct with full PBR properties:
  - diffuse_color, metallic, roughness, specular, opacity, emissive_color
  - Texture paths: diffuse, roughness, metallic, normal, emissive
- Added `has_textures()`, `is_emissive()` helpers
- Added materials storage to Scene with add/get methods
- Commit: `feat: expand Material struct with full PBR properties`

### Phase 3: C++ Bridge Material Extraction
- Added UsdBridgeMaterialData struct with PBR properties + texture paths
- Added usd_bridge_get_material_count/get_material functions
- Added usd_bridge_get_mesh_material_path for material bindings
- Parse UsdPreviewSurface shader network + texture connections
- Link usd_usdShade library
- Commit: `feat: add UsdPreviewSurface material extraction to C++ bridge`

### Phase 4: Rust Material Loading
- Added UsdMaterialData struct and FFI bindings
- Added material_count(), get_material(), get_mesh_material_path() to UsdStage
- Updated loader to load materials and bind to prototypes
- Commit: `feat: add Rust material loading from USD`

## Commits This Session
```
e57fe6f feat: add UV coordinate support throughout mesh pipeline
43d2a5a feat: expand Material struct with full PBR properties
08ffc9b feat: add UsdPreviewSurface material extraction to C++ bridge
d2790a5 feat: add Rust material loading from USD
```

## Remaining Phases
- Phase 5: Texture loading system
- Phase 6: Disney Principled BSDF
- Phase 7: Ivar material integration
- Phase 8: Viewport texture support
- Phase 9: Testing and documentation

## Key Files Modified

| File | Changes |
|------|---------|
| `crates/bif_core/src/mesh.rs` | Added uvs field |
| `crates/bif_core/src/scene.rs` | Expanded Material struct |
| `cpp/usd_bridge/usd_bridge.h` | Material data struct + APIs |
| `cpp/usd_bridge/usd_bridge.cpp` | UsdShade extraction |
| `crates/bif_core/src/usd/cpp_bridge.rs` | Material FFI bindings |
| `crates/bif_core/src/usd/loader.rs` | Material loading |
| `crates/bif_viewport/src/lib.rs` | UV in Vertex, shifted instance locs |
| `crates/bif_viewport/src/shaders/basic.wgsl` | UV attribute |
| `crates/bif_core/build.rs` | Link usd_usdShade |

## Learnings
- UsdShade material network: Material -> Surface output -> Shader prim -> Inputs
- UsdPreviewSurface inputs: diffuseColor, metallic, roughness, opacity, etc.
- Texture connections: Input -> UsdUVTexture shader -> file input with SdfAssetPath
- wgpu vertex attribute locations need to be sequential; shifted instance data to 4-7

## Next Session
- Phase 5: Texture loading (image crate)
- Phase 6: Disney BSDF implementation
- Phase 7-8: Integration into Ivar and viewport
